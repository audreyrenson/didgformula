<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Audrey Renson" />


<title>Introduction to didgformula</title>

<script>// Hide empty <a> tag within highlighted CodeBlock for screen reader accessibility (see https://github.com/jgm/pandoc/issues/6352#issuecomment-626106786) -->
// v0.0.1
// Written by JooYoung Seo (jooyoung@psu.edu) and Atsushi Yasumoto on June 1st, 2020.

document.addEventListener('DOMContentLoaded', function() {
  const codeList = document.getElementsByClassName("sourceCode");
  for (var i = 0; i < codeList.length; i++) {
    var linkList = codeList[i].getElementsByTagName('a');
    for (var j = 0; j < linkList.length; j++) {
      if (linkList[j].innerHTML === "") {
        linkList[j].setAttribute('aria-hidden', 'true');
      }
    }
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Introduction to didgformula</h1>
<h4 class="author">Audrey Renson</h4>



<div id="overview" class="section level2">
<h2>Overview</h2>
<p>Suppose we observe <span class="math inline">\(N\)</span> iid copies of <span class="math inline">\((L_t, A_t, Y_t)\)</span> over periods <span class="math inline">\(t=0,1,...,T\)</span>, where <span class="math inline">\(Y_t\)</span> is a continuous outcome, <span class="math inline">\(A_t\)</span> is a binary (time-varying) treatment, and <span class="math inline">\(L_t\)</span> is a binary (time-varying) covariate. Denote potential outcomes <span class="math inline">\(Y_t(\bar a)\)</span>, as the outcome that would have occurred at time <span class="math inline">\(t\)</span> had treatment history <span class="math inline">\(\bar a\)</span> been received. Say we with to estimate the quantity</p>
<p><span class="math display">\[
E[Y_t(\bar a) - Y_{t-1}(\bar a)]
\]</span></p>
<p>Say we are willing to make the following assumptions:</p>
<ol style="list-style-type: decimal">
<li><p>SUTVA <span class="math display">\[
\bar A = \bar a \implies Y_t(\bar a) = Y_t
\]</span></p></li>
<li><p>Positivity <span class="math display">\[
P(A_t=a_t|\bar L_t=\bar l_t, \bar A_{t-1}=\bar a_{t-1}) &gt; 0
\]</span> if <span class="math inline">\(P(\bar L_t=\bar l_t, \bar A_{t-1}=\bar a_{t-1})&gt;0\)</span>.</p></li>
<li><p>Parallel trends</p></li>
</ol>
<p><span class="math display">\[
E[Y_t(\bar a) - Y_{t-1}(\bar a)|\bar A_{k-1}=\bar a_{k-1}, \bar L_k]=E[Y_t(\bar a) - Y_{t-1}(\bar a)|\bar A_k=\bar a_k, \bar L_k]
\]</span> for <span class="math inline">\(k\in\{0,...,t\}\)</span>, and <span class="math inline">\(t \in \{0,1,..., T\}\)</span>.</p>
<p>Under assumptions 1-3, the quantity of interest is identified as:</p>
<p><span class="math display">\[
E[Y_t(\bar a) - Y_{t-1}(\bar a)] = \sum_{\bar l}E[Y_t - Y_{t-1}|\bar L=\bar l, \bar A=\bar a] \prod_{k=0}^tP(L_k=l_k |\bar A_{k-1}=\bar a_{k-1}, \bar L_{k-1}=\bar l_{k-1})
\]</span> I.e., the difference in differences g-formula. We can estimate this population quantity using inverse weighting, iterated conditional outcome modeling, or by modeling the outcome and covariates. Each of these approaches is implemented in <code>didgformula</code>, by default targeting the above-described quantity.</p>
<p>Often a quantity such as <span class="math inline">\(E[Y_t(\bar a)\)</span> is of more interest. Under the setting where <span class="math inline">\(A_0=a_0\)</span> for all individuals in the population, we have <span class="math display">\[
E[Y_t(\bar a) = E[Y_0] + \sum_{t=1}^T E[Y_t(\bar a) - Y_{t-1}(\bar a)]
\]</span> Thus the quantity <span class="math inline">\(E[Y_t(\bar a)\)</span> is also identified. However, it is helpful to focus on estimating the differences, since any quantities that we can identify under parallel trends are identified and estimated by way of the differences.</p>
</div>
<div id="simulating-data-under-parallel-trends" class="section level2">
<h2>Simulating data under parallel trends</h2>
<p><code>didgformula</code> contains basic functionality for simple simulations under parallel trends. The default setup has one unmeasured baseline covariate, <span class="math inline">\(U_0\)</span>, time-varying binary covariates <span class="math inline">\(L_t\)</span>, binary treatments <span class="math inline">\(A_t\)</span>, and continuous outcomes <span class="math inline">\(Y_t\)</span>, observed over periods <span class="math inline">\(t=0,1,...,T\)</span>. First we select parameters for the data-generating models, which are generated from a normal distribution by default (with the exception of <span class="math inline">\(U_0\)</span> which always has prevalence <span class="math inline">\(0.5\)</span>). For now the parameters are packaged as a list of matrices with <span class="math inline">\(T+1\)</span> rows and the same number of columns as coefficients in the data-generating models:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(didgformula)</span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">set.seed</span>(<span class="dv">10</span>)</span>
<span id="cb1-4"><a href="#cb1-4"></a>N_obs =<span class="st"> </span><span class="fl">1e4</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>time_periods =<span class="st"> </span><span class="dv">5</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>parameters =<span class="st"> </span><span class="kw">generate_parameters</span>(<span class="dt">Tt=</span>time_periods)</span>
<span id="cb1-7"><a href="#cb1-7"></a>parameters</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co">#&gt; $U</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co">#&gt; </span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co">#&gt; $L</span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co">#&gt;       intercept        At-1</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="co">#&gt; [1,] -0.5967354 -0.04161524</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="co">#&gt; [2,] -1.1806532  0.12726480</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="co">#&gt; [3,] -0.1875110 -0.12533454</span></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="co">#&gt; [4,] -0.1387988  0.14870432</span></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="co">#&gt; [5,] -0.3948326  0.42035590</span></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="co">#&gt; [6,] -2.2205639  0.35115630</span></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="co">#&gt; </span></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="co">#&gt; $A</span></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="co">#&gt;      intercept          U0          Lt</span></span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="co">#&gt; [1,] -1.599269  0.38510425 -0.05303960</span></span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="co">#&gt; [2,] -2.541398  0.29659570  0.12526769</span></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="co">#&gt; [3,] -2.231964  0.08073787  0.06248891</span></span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="co">#&gt; [4,] -2.130096 -0.23705737  0.02556823</span></span>
<span id="cb1-26"><a href="#cb1-26"></a><span class="co">#&gt; [5,] -1.612860  0.06502681  0.17964780</span></span>
<span id="cb1-27"><a href="#cb1-27"></a><span class="co">#&gt; [6,] -1.216170 -0.22381224  0.14924389</span></span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="co">#&gt; </span></span>
<span id="cb1-29"><a href="#cb1-29"></a><span class="co">#&gt; $Y</span></span>
<span id="cb1-30"><a href="#cb1-30"></a><span class="co">#&gt;       intercept  U0          Lt         At LtU0</span></span>
<span id="cb1-31"><a href="#cb1-31"></a><span class="co">#&gt; [1,] -3.9952687 0.1 0.034267493 0.06447708    0</span></span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="co">#&gt; [2,] -1.8868903 0.1 0.366894781 0.33104553    0</span></span>
<span id="cb1-33"><a href="#cb1-33"></a><span class="co">#&gt; [3,] -1.8521967 0.1 0.006469603 0.11987249    0</span></span>
<span id="cb1-34"><a href="#cb1-34"></a><span class="co">#&gt; [4,]  0.4573468 0.1 0.194236933 0.13308869    0</span></span>
<span id="cb1-35"><a href="#cb1-35"></a><span class="co">#&gt; [5,] -3.3728855 0.1 0.246505031 0.47359079    0</span></span>
<span id="cb1-36"><a href="#cb1-36"></a><span class="co">#&gt; [6,] -3.2558885 0.1 0.139758264 0.62755342    0</span></span></code></pre></div>
<p>To simulate, this list gets passed into <code>generate_data()</code> as the <code>Beta</code> parameter. By default, <span class="math inline">\(A_t\)</span> and <span class="math inline">\(L_t\)</span> following a binary logistic model and <span class="math inline">\(Y_t\)</span> follows a normal identity-link model (the residual variance is set to <span class="math inline">\(1\)</span>).</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>df_linear &lt;-<span class="st"> </span><span class="kw">generate_data</span>(<span class="dt">N=</span>N_obs, <span class="dt">Tt=</span>time_periods, <span class="dt">Beta =</span> parameters)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="kw">head</span>(df_linear)</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">#&gt;   uid U0 L0 A0 L1 A1 L2 A2 L3 A3 L4 A4 L5 A5        Y0         Y1        Y2         Y3         Y4        Y5</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co">#&gt; 1   1  0  0  0  0  0  0  0  0  0  1  0  0  0 -3.709920 -0.3952357 -1.261863  0.7014492 -1.4779028 -1.406029</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co">#&gt; 2   2  1  0  0  0  0  1  0  0  0  0  1  1  1 -3.854362 -1.1734846 -1.191749  1.0758640 -3.5399963 -3.469775</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co">#&gt; 3   3  1  1  0  1  0  0  0  1  0  0  0  0  0 -1.745095 -2.2075795 -1.621523  1.0736244 -0.2759224 -3.140381</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co">#&gt; 4   4  0  0  0  1  0  1  0  0  0  0  1  0  1 -4.711329 -3.6008658 -3.044589 -1.2128836 -2.7264771 -1.703649</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">#&gt; 5   5  0  1  0  0  1  0  1  1  1  0  1  0  1 -5.324419 -2.0311255 -2.491417  3.0419038 -3.3059193 -2.178385</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="co">#&gt; 6   6  1  0  0  0  0  0  0  1  0  0  0  0  0 -4.838783 -0.8775368 -1.332158 -0.9878000 -3.7618285 -4.228438</span></span></code></pre></div>
<p>We can calculate the true values of the parameters <span class="math inline">\(E[Y_t(\bar a) - Y_{t-1}(\bar a)]\)</span> by generating a large number of potential outcomes under the same data-generating mechanism. The estimates are just column means of the differences <code>Yt</code>-<code>Yt-1</code> in the simulated potential outcomes data:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>df_po =<span class="st"> </span><span class="kw">generate_data</span>(<span class="dt">N=</span>N_obs<span class="op">*</span><span class="dv">10</span>, <span class="dt">Tt=</span>time_periods, <span class="dt">Beta=</span>parameters,  <span class="dt">potential_outcomes =</span> <span class="ot">TRUE</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a>truth =<span class="st"> </span><span class="kw">estimate_truth</span>(df_po, <span class="dt">Tt=</span>time_periods)</span>
<span id="cb3-4"><a href="#cb3-4"></a>truth</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">#&gt; # A tibble: 5 x 2</span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="co">#&gt;       t estimate</span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">#&gt;   &lt;int&gt;    &lt;dbl&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="co">#&gt; 1     1   2.19  </span></span>
<span id="cb3-9"><a href="#cb3-9"></a><span class="co">#&gt; 2     2  -0.0588</span></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="co">#&gt; 3     3   2.39  </span></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co">#&gt; 4     4  -3.81  </span></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="co">#&gt; 5     5   0.0306</span></span></code></pre></div>
<p>The data-generating mechanism used by default in <code>generate_data()</code> is:</p>
<p><span class="math display">\[ U_0 \sim \text{Bernoulli}(0.5) \]</span> <span class="math display">\[ L_t \sim \text{Bernoulli}(\text{logit}^{-1}[\gamma_{0t} + \gamma_{1t}A_{t-1}]) \]</span> <span class="math display">\[ A_0 = 0\]</span> <span class="math display">\[(A_t | A_{t-1} = 1) = 1\]</span> <span class="math display">\[(A_t | A_{t-1} = 0) \sim \text{Bernoulli}(\text{logit}{-1}[\alpha_{0t} +\alpha_{1t}U_0 + \alpha_{2t}L_t])\]</span> <span class="math display">\[Y_t \sim \text{Normal}(\beta_{0t} + \beta_{1t}A_t + \beta_{2t}L_t + \beta_3U_0 + \beta_4U_0L_t, \sigma^2_t)\]</span> This data-generating mechanism is consistent with with parallel trends, provable by the fact that <span class="math inline">\(L_t \coprod U_0 |\bar L_{t-1}, \bar A_{t-1}=\bar a_{t-1}\)</span> and <span class="math inline">\(\frac{\partial E[Y_t|\bar L_t, \bar A_t=\bar a_t, U_0]}{\partial U_0}=\frac{\partial E[Y_{t-1}|\bar L_t, \bar A_t=\bar a_t, U_0]}{\partial U_0}=0.1\)</span>. We can check that parallel trends is approximately satisfied in the simulated potential outcomes data using the packaged function <code>pt_deviation_histograms(.)</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">pt_deviation_histograms</span>(df_po, <span class="dt">Tt=</span>time_periods)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
<p>The matrix of histograms has <span class="math inline">\(t\)</span> on the x-axis and <span class="math inline">\(k\)</span> on the y-axis, so that the <span class="math inline">\((t, k)\)</span>th cell displays estimates of <span class="math inline">\(E[Y_t(\bar a) - Y_{t-1}(\bar a)|\bar A_{k-1}=\bar a_{k-1}, \bar L_k]=E[Y_t(\bar a) - Y_{t-1}(\bar a)|\bar A_k=\bar a_k, \bar L_k]\)</span> across possible values of <span class="math inline">\(\bar L_k\)</span> (actually, just <span class="math inline">\(L_k\)</span> is sufficient based on the data-generating mechanism). These estimates should look like unbiased estimates of zero (each cell should look like it has mean 0, the red line). If not, something might be wrong with the data-generating mechanism (but first try generating a larger number of potential outcomes, since restricting to <span class="math inline">\(\bar A_{k-1}=\bar a_{k-1}\)</span> can result in very small sample sizes). To zoom in on a particular value of <span class="math inline">\(k\)</span>, we can use the <code>k</code> argument in <code>pt_deviation_histograms(.)</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">pt_deviation_histograms</span>(df_po, <span class="dt">Tt=</span>time_periods, <span class="dt">k=</span><span class="dv">2</span>)</span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
</div>
<div id="estimation" class="section level2">
<h2>Estimation</h2>
<p>All the estimation pipelines in <code>didgformula</code> are written as functions called <code>*_pipeline()</code> and have similar (but not exactly the same) arguments. All target the estimands <span class="math inline">\(E[Y_t(\bar a) - Y_{t-1}(\bar a)]\)</span>, for <span class="math inline">\(t=1,2,...,T\)</span>. Currently, all expect a wide-format dataset like the one returned by <code>generate_data(.)</code>, with outcome columns labeled <code>Y0</code>,<code>Y1</code>,…, treatments <code>A0</code>, <code>A1</code>, …, and for each covariate <code>L</code>, <code>L0</code>, <code>L1</code>, …. The covariates do not need to be called <code>L</code> but they do need to be numbered.</p>
<p>Formulas in <code>didgformula</code> are character (not formula), only right-hand-side, and use <code>glue</code>-style string interpolation to interpret time indicators. For example, <code>iptw_pipeline()</code> expects a right-hand-side formula for the denominator models via the argument <code>den_formula</code>, and likewise for the numerator models via <code>num_formula</code>. For example, the formula <code>&quot;~x{t}+x{t-1}+y{t}</code> says that in the model for <code>A1</code>, covariates <code>x1</code>, <code>x0</code>, and <code>y1</code> should be included as main terms, and in the model for <code>A2</code>, covariates <code>x2</code>, <code>x1</code>, and <code>y2</code>, etc. All these covariates need to be in the dataset and labeled accordingly. The formulas for <code>or_pipeline</code> and <code>ice_pipeline</code> work similarly.</p>
<p>For example:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>estimates_iptw =<span class="st"> </span><span class="kw">iptw_pipeline</span>(<span class="dt">data =</span> df_linear, <span class="dt">den_formula =</span> <span class="st">&#39;~L{t}&#39;</span>, <span class="dt">num_formula =</span> <span class="st">&#39;~1&#39;</span>, <span class="dt">Tt=</span>time_periods)</span>
<span id="cb6-2"><a href="#cb6-2"></a>estimates_iptw</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co">#&gt; # A tibble: 5 x 2</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">#&gt;       t estimate</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">#&gt;   &lt;int&gt;    &lt;dbl&gt;</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co">#&gt; 1     1   2.17  </span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co">#&gt; 2     2  -0.0270</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co">#&gt; 3     3   2.39  </span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="co">#&gt; 4     4  -3.83  </span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="co">#&gt; 5     5   0.0455</span></span></code></pre></div>
<p>The column <code>estimate</code> gives estimates of <span class="math inline">\(E[Y_t(\bar a) - Y_{t-1}(\bar a)]\)</span> for each <span class="math inline">\(t\)</span> in the column <code>t</code>.</p>
<p><code>ice_pipeline</code> fits the iterative conditional estimator. <code>inside_formula_t</code> receives a right-hand-side formula for the outcome regression estimators of the innermost conditional expectation of <span class="math inline">\(Y_t\)</span>, <code>inside_formula_tmin1</code> for <span class="math inline">\(Y_{t-1}\)</span>. <code>outside_formula</code> refers to the models for every nested expectation except the innermost one (note that the time indicator is labeled <code>{k}</code> for the outside formula.)</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>estimates_ice =<span class="st"> </span><span class="kw">ice_pipeline</span>(<span class="dt">data =</span> df_linear, <span class="dt">inside_formula_t =</span> <span class="st">&#39;~L{t}&#39;</span>, <span class="dt">inside_formula_tmin1 =</span> <span class="st">&#39;~L{t-1}&#39;</span>, <span class="dt">outside_formula =</span> <span class="st">&#39;~L{k}&#39;</span>, <span class="dt">Tt=</span>time_periods)</span>
<span id="cb7-2"><a href="#cb7-2"></a>estimates_ice</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co">#&gt; # A tibble: 5 x 2</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co">#&gt;       t estimate</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co">#&gt;   &lt;int&gt;    &lt;dbl&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="co">#&gt; 1     1   2.17  </span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="co">#&gt; 2     2  -0.0278</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="co">#&gt; 3     3   2.39  </span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co">#&gt; 4     4  -3.83  </span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="co">#&gt; 5     5   0.0447</span></span></code></pre></div>
<p><code>or_pipeline</code> fits the monte-carlo outcome regression estimator, and accepts right-hand side formulas for the outcome models (<code>y_formula</code>, and similarly there are two models fit for each <span class="math inline">\(t\)</span>) and covariate models (<code>l_formula</code>).</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>estimates_or =<span class="st"> </span><span class="kw">or_pipeline</span>(<span class="dt">data =</span> df_linear, <span class="dt">yt_formula =</span> <span class="st">&#39;~L{t}&#39;</span>, <span class="dt">ytmin1_formula =</span> <span class="st">&#39;~L{t}&#39;</span>, <span class="dt">l_formula =</span> <span class="st">&#39;~1&#39;</span>, <span class="dt">Tt=</span>time_periods, <span class="dt">nreps=</span>N_obs) <span class="co">#usually nreps should be much larger but in this example it appears fine</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>estimates_or</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="co">#&gt; # A tibble: 5 x 2</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="co">#&gt;       t estimate</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="co">#&gt;   &lt;int&gt;    &lt;dbl&gt;</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="co">#&gt; 1     1   2.17  </span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="co">#&gt; 2     2  -0.0255</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="co">#&gt; 3     3   2.39  </span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="co">#&gt; 4     4  -3.83  </span></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="co">#&gt; 5     5   0.0489</span></span></code></pre></div>
<p>We can compare all these estimates (which should be very precisely similar) along with the estimated “truth” (which should be pretty close):</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">combine_estimates</span>(truth, estimates_iptw, estimates_ice, estimates_or, <span class="dt">Tt=</span>time_periods)</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="co">#&gt; # A tibble: 5 x 5</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co">#&gt;       t   truth    iptw     ice      or</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co">#&gt;   &lt;int&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="co">#&gt; 1     1  2.19    2.17    2.17    2.17  </span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="co">#&gt; 2     2 -0.0588 -0.0270 -0.0278 -0.0255</span></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="co">#&gt; 3     3  2.39    2.39    2.39    2.39  </span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="co">#&gt; 4     4 -3.81   -3.83   -3.83   -3.83  </span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="co">#&gt; 5     5  0.0306  0.0455  0.0447  0.0489</span></span></code></pre></div>
<p>Since we used saturated models, the estimates from each estimator are nearly identical. In general, large differences among the estimates from different estimators suggest the presence of model mispecification, since with correctly specified models all three target the same quantity. If we were interested in <span class="math inline">\(E[Y_t(\bar a)]\)</span>, since the data-generating mechanism has <span class="math inline">\(A_0=0\)</span> with probability 1, we have:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>EY0_truth =<span class="st"> </span><span class="kw">mean</span>(df_po<span class="op">$</span>Y0)</span>
<span id="cb10-2"><a href="#cb10-2"></a>EY0_data  =<span class="st"> </span><span class="kw">mean</span>(df_linear<span class="op">$</span>Y0)</span>
<span id="cb10-3"><a href="#cb10-3"></a></span>
<span id="cb10-4"><a href="#cb10-4"></a>EYat_truth =<span class="st"> </span>tibble<span class="op">::</span><span class="kw">tibble</span>(<span class="dt">t=</span><span class="dv">1</span><span class="op">:</span>time_periods, <span class="dt">estimate =</span> EY0_truth <span class="op">+</span><span class="st"> </span><span class="kw">cumsum</span>(truth<span class="op">$</span>estimate))</span>
<span id="cb10-5"><a href="#cb10-5"></a>EYat_iptw =<span class="st"> </span>tibble<span class="op">::</span><span class="kw">tibble</span>(<span class="dt">t=</span><span class="dv">1</span><span class="op">:</span>time_periods, <span class="dt">estimate =</span> EY0_data <span class="op">+</span><span class="st"> </span><span class="kw">cumsum</span>(estimates_iptw<span class="op">$</span>estimate))</span>
<span id="cb10-6"><a href="#cb10-6"></a>EYat_ice =<span class="st"> </span>tibble<span class="op">::</span><span class="kw">tibble</span>(<span class="dt">t=</span><span class="dv">1</span><span class="op">:</span>time_periods, <span class="dt">estimate =</span> EY0_data <span class="op">+</span><span class="st"> </span><span class="kw">cumsum</span>(estimates_ice<span class="op">$</span>estimate))</span>
<span id="cb10-7"><a href="#cb10-7"></a>EYat_or =<span class="st"> </span>tibble<span class="op">::</span><span class="kw">tibble</span>(<span class="dt">t=</span><span class="dv">1</span><span class="op">:</span>time_periods, <span class="dt">estimate =</span> EY0_data <span class="op">+</span><span class="st"> </span><span class="kw">cumsum</span>(estimates_or<span class="op">$</span>estimate))</span>
<span id="cb10-8"><a href="#cb10-8"></a></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="kw">combine_estimates</span>(EYat_truth, EYat_iptw, EYat_ice, EYat_or, <span class="dt">Tt=</span>time_periods)</span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="co">#&gt; # A tibble: 5 x 5</span></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="co">#&gt;       t  truth   iptw    ice     or</span></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="co">#&gt;   &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb10-13"><a href="#cb10-13"></a><span class="co">#&gt; 1     1 -1.74  -1.77  -1.77  -1.77 </span></span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="co">#&gt; 2     2 -1.80  -1.80  -1.80  -1.79 </span></span>
<span id="cb10-15"><a href="#cb10-15"></a><span class="co">#&gt; 3     3  0.591  0.595  0.595  0.596</span></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="co">#&gt; 4     4 -3.22  -3.23  -3.23  -3.23 </span></span>
<span id="cb10-17"><a href="#cb10-17"></a><span class="co">#&gt; 5     5 -3.19  -3.19  -3.19  -3.18</span></span></code></pre></div>
</div>
<div id="bootstrap-standard-errors" class="section level2">
<h2>Bootstrap standard errors</h2>
<p>As of this writing, analytic standard errors for the estimators in <code>didgformula</code> have not been derived. We make conveniently available bootstrap standard errors for any of the estimators implemented in this package via the <code>bootstrap_se</code> function. Simply pass the <code>*_pipeline()</code> function corresponding to the relevant estimator as the <code>estimator</code> argument, along with named arguments to that function as the <code>...</code>. These are standard error estimates for the estimates of <span class="math inline">\(E[Y_t(\bar a)-Y_{t-1}(\bar a)]\)</span> (or <span class="math inline">\(g(E[Y_t(\bar a)]) - g(E[Y_{t-1}(\bar a)])\)</span> in the case of a generalized parallel trends workflow - see for example the survival-outcomes vignette).</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a></span>
<span id="cb11-2"><a href="#cb11-2"></a>se_iptw =<span class="st"> </span><span class="kw">bootstrap_se</span>(<span class="dt">data =</span> df_linear, </span>
<span id="cb11-3"><a href="#cb11-3"></a>                       <span class="dt">nboots =</span> <span class="dv">10</span>, <span class="co">#obviously you should use many more than 10</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>                       <span class="dt">estimator =</span> iptw_pipeline,</span>
<span id="cb11-5"><a href="#cb11-5"></a>                       <span class="dt">den_formula =</span> <span class="st">&#39;~L{t}&#39;</span>,</span>
<span id="cb11-6"><a href="#cb11-6"></a>                       <span class="dt">num_formula =</span> <span class="st">&#39;~1&#39;</span>,</span>
<span id="cb11-7"><a href="#cb11-7"></a>                       <span class="dt">Tt =</span> time_periods)</span>
<span id="cb11-8"><a href="#cb11-8"></a></span>
<span id="cb11-9"><a href="#cb11-9"></a>se_iptw                       </span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="co">#&gt; # A tibble: 5 x 2</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="co">#&gt;       t     se</span></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="co">#&gt;   &lt;int&gt;  &lt;dbl&gt;</span></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="co">#&gt; 1     1 0.0125</span></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="co">#&gt; 2     2 0.0141</span></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="co">#&gt; 3     3 0.0136</span></span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="co">#&gt; 4     4 0.0121</span></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="co">#&gt; 5     5 0.0173</span></span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
